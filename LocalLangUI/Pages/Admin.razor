@page "/AdminPedar"

@inject IExpressionCollection dbExpressions
@inject NavigationManager navManager

<h1 class="page-heading text-uppercase mb-4">@LabelResource.AdminHeading</h1>

<div class="row">
    <div class="expression-count col-8 mt-2">@submissions_?.Count @GetSubmissionCountText()</div>
    <div class="col-4 close-button-section">
        <button class="btn" @onclick="ClosePage">🗙</button>
    </div>
</div>

@if (submissions_ is not null)
{
    @foreach (var e in submissions_)
    {
        <div class="row submission">
            <div class="col-lg-2 col-md-3 col-sm-4">
                <button class="btn btn-approve" @onclick="() => Approve(e)">@LabelResource.ApproveButtoon</button>
                <button class="btn btn-reject" @onclick="() => Reject(e)">@LabelResource.RejectButton</button>
            </div>
            <div class="col-lg-10 col-md-9 col-sm-8">
                <div>
                    @if (editedExpressionId_ == e.Id && isWordEdited_)
                    {
                        <EditForm class="approval-edit-form" Model="@editedWord_" OnSubmit="() => Save(e)">
                            <InputText class="form-control approval-edit-field" @bind-Value="editedWord_" />
                            <button class="btn" type="submit">
                                <span class="oi oi-check submission-edit-approve"></span>
                            </button>
                            <button class="btn" type="button" @onclick="Cancel">
                                <span class="oi oi-x submission-edit-reject"></span>
                            </button>
                        </EditForm>
                    }
                    else
                    {
                        @e.Word
                        <span class="oi oi-pencil submission-edit-icon" @onclick="() => EditWord(e)"></span>
                    }
                </div>
                <div>
                    <div>
                        @if (editedExpressionId_ == e.Id && isTranslationEdited_)
                        {
                            <EditForm class="approval-edit-form" Model="@editedTranslation_" OnSubmit="(() => Save(e))">
                                <InputText class="form-control approval-edit-field" @bind-Value="editedTranslation_" />
                                <button class="btn" type="submit">
                                    <span class="oi oi-check submission-edit-approve"></span>
                                </button>
                                <button class="btn" type="button" @onclick="Cancel">
                                    <span class="oi oi-x submission-edit-reject"></span>
                                </button>
                            </EditForm>
                        }
                        else
                        {
                            @e.Translation
                            <span class="oi oi-pencil submission-edit-icon" @onclick="() => EditTranslation(e)"></span>
                        }
                    </div>
                </div>
                <div>
                    @e.Category.Name
                </div>
            </div>
        </div>
    }
}

@code {
    private IList<Expression>? submissions_;

    private string editedExpressionId_ = string.Empty;
    private bool isWordEdited_ = false;
    private bool isTranslationEdited_ = false;

    private string editedWord_ = string.Empty;
    private string editedTranslation_ = string.Empty;

    protected async override Task OnInitializedAsync()
    {
        submissions_ = await dbExpressions.GetPendingAsync();
    }

    private void ClosePage()
    {
        navManager.NavigateTo("/");
    }

    private async Task Approve(Expression submission)
    {
        submission.Status = Status.Approved;
        submissions_?.Remove(submission);
        await dbExpressions.UpdateAsync(submission);
    }

    private async Task Reject(Expression submission)
    {
        submission.Status = Status.Rejected;
        submissions_?.Remove(submission);
        await dbExpressions.UpdateAsync(submission);
    }

    private void EditWord(Expression expression)
    {
        editedExpressionId_ = expression.Id;
        isWordEdited_ = true;
        isTranslationEdited_ = false;

        editedWord_ = expression.Word;
    }

    private void EditTranslation(Expression expression)
    {
        editedExpressionId_ = expression.Id;
        isWordEdited_ = false;
        isTranslationEdited_ = true;

        editedTranslation_ = expression.Translation;
    }

    private async Task Save(Expression expression)
    {
        if (isWordEdited_)
        {
            isWordEdited_ = false;
            expression.Word = editedWord_;
        }

        if (isTranslationEdited_)
        {
            isTranslationEdited_ = false;
            expression.Translation = editedTranslation_;
        }

        await dbExpressions.UpdateAsync(expression);
    }

    private void Cancel()
    {
        editedExpressionId_ = string.Empty;
    }

    private string GetSubmissionCountText()
    {
        var count = submissions_?.Count ?? 0;

        return (count % 100, count % 10) switch
        {
            (1, _) => LabelResource.Submission,
            ( >= 2 and <= 4, _) => LabelResource.SubmissionPlural2to4,
            ( > 4 and <= 20, _) => LabelResource.SubmissionPlural,
            (_, 1) => LabelResource.Submission,
            (_, >= 2 and <= 4) => LabelResource.SubmissionPlural2to4,
            _ => LabelResource.SubmissionPlural,
        };
    }
}
